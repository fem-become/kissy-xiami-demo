KISSY.add("xiami/transition/player",function(d,o,t,j,k,p,q,l,m){var c=o.all,i,g=this.getName(),r=c("#body"),h={},f=null,e={},n=null;d.Player=new d.Base;d.plScrollView=null;var s=localStorage.getItem("MUSIC_LIST")?localStorage.getItem("MUSIC_LIST").split(","):[];d.mix(h,{init:function(a){this.bringRest();k.setTitle("播放器");!a||!a.id?(e.id=s[0],e.src="http://m1.file.xiami.com/224/224/992/12345_95993_l.mp3"):(e.id=a.id,e.src=a.src||"http://m1.file.xiami.com/224/224/992/12345_95993_l.mp3");i?d.log(g+" is coming again"):
(i=c('<div class="mod-page"></div>').appendTo(r),i.html('<div id="J_PlTabContent" class="pl-tab-content">\t<div id="J_PlayerTab" class="pl-player-tab">\t\t<div class="pl-img-tab" id="J_PlImgTab">\t\t\t<div class="pl-img-content">\t\t\t\t<img class="pl-img" id="J_PlImg" src="http://www.lettersmarket.com/uploads/lettersmarket/blog/loaders/common_metal/ajax_loader_metal_64.gif" alt="img">\t\t\t</div>\t\t\t</div>\t\t<div class="pl-list-tab" id="J_PlListTab" style="display:none">\t\t\t<div class="ks-scrollview-content ks-content">\t\t\t<ul class="pl-music-list" id="J_PlMusicList">\t\t\t\t<li><img class="pl-img" src="http://www.lettersmarket.com/uploads/lettersmarket/blog/loaders/common_metal/ajax_loader_metal_64.gif" alt="img"></li>\t\t\t</ul>\t\t\t</div>\t\t</div>\t</div></div><div id="J_PlayInfo" class="pl-play-info">\t<ul class="pl-tab-icon" id="J_TabHandle">\t\t<li id="J_TabImg" data-index="0" class="J_PlayTabIcon pl-hover">\t\t</li>\t\t<li id="J_TabList" data-index="1" class="J_PlayTabIcon">\t\t</li>\t</ul>\t<p id="J_PlayTime" class="pl-play-time">\t\t<em id="J_CurrentTime" class="pl-current">\t\t\t00:00\t\t</em>\t\t<em id="J_TotalTime" class="pl-total">\t\t\t4:02\t\t</em>\t</p>\t<div id="J_PlayBar" class="pl-play-bar">\t\t<p id="J_PlayProgress" class="pl-progress"></p>\t\t<em id="J_PlayBarIcon" class="pl-bar-icon"></em>\t</div>\t<div class="pl-player-handle">\t\t<span id="J_PlayLast" class="pl-last">\t\t\t<em>last</em>\t\t</span>\t\t<span id="J_PlaySwitch" class="pl-switch pl-pause">\t\t\t<em>play/pause</em>\t\t</span>\t\t<span id="J_PlayNext" class="pl-next">\t\t\t<em>next</em>\t\t</span>\t</div></div>'),
d.log(g+" is new"));this.render();this.fillList();this._bindEvent();var a=c("#J_PlayInfo").height(),b=c(window).height()-a-45;c(window).width();console.log(c(window).height()+" "+a);c("#J_PlayerTab").height(b);c("#J_PlImg").css({"margin-top":(b-185-16)/2+"px"});n=(new l({srcNode:"#J_PlListTab",plugins:[new m({})]})).render();a=k.getHeader(g);a.contents().length||a.append(g)},getEl:function(){return i},setScrollView:function(){d.plScrollView||(d.plScrollView=new l({srcNode:"#J_PlTabContent",plugins:[new m({})]}),
d.plScrollView.render())},_bindEvent:function(){var a=this;this.playNext();this.playPrev();this._bindTabSwitch();a=this;d.Player.on("go-back",function(){a.bringRest()})},render:function(){d.player&&d.player.pause();this.createAudio(e.src);this.getMusicInfo(e.id,function(){c("#J_PlImg").attr("src",e.albumCover)});return this},createAudio:function(a){var b=this;d.player||(d.player=new Audio);d.player.src=a;d.player.load();c("#J_TotalTime").html("loading");c(d.player).on("canplay",function(){h._changeProgress();
h._setProgress();b._startPlay();b._switchMusic()});return d.player},getAudio:function(){return player},stop:function(a){d.player&&d.player.pause();a&&a();return this},play:function(a){d.player.play();a&&a();return this},getTotalTime:function(){return d.player&&d.player.duration||0},bringRest:function(){d.player&&(d.player.pause(),d.player.currentTime&&(d.player.currentTime=0),f&&f.cancel(),c("#J_CurrentTime").html("0:00"),c("#J_PlayProgress").css("width",0),c("#J_PlayBarIcon").css("left",0),c("#J_PlaySwitch").replaceClass("pl-play",
"pl-pause"),d.player=null);return this},getMusicInfo:function(a,b){d.io({type:"get",url:"http://test.fem.taobao.net:3000/song/"+e.id,dataType:"jsonp",success:function(a){d.mix(e,a);b&&b()},error:function(){alert("error");b&&b()}});return this},updateProgress:function(a){f=d.later(function(){h._changeProgress()},a||200,!0);return this},getWindowWidth:function(){return c(window).width()},_changeProgress:function(){var a=c("#J_PlayProgress"),b=c("#J_CurrentTime"),d=c("#J_TotalTime"),e=c("#J_PlayBarIcon"),
f=c(".is-playing").children(".J_PlListBar"),h=this.progress(),i=this.getTotalTime(),g=h/i*this.getWindowWidth();a.css({width:g});f.css({width:g});e.css({left:g>this.getWindowWidth()-8?this.getWindowWidth()-8:g});b.html(this.formatTime(h));d.html(this.formatTime(i))},formatTime:function(a){var b=Math.floor(a%60);9>=b&&(b="0"+b);return Math.floor(a/60)+":"+b},progress:function(a){return a?(d.player.currentTime=a,this):d.player.currentTime},_switchMusic:function(){var a=this,b;c("#J_PlaySwitch").detach("click").on("click",
function(){b=c(this);b.hasClass("pl-pause")?a._startPlay():a.stop(function(){f&&f.cancel();b.replaceClass("pl-play","pl-pause")})})},playNext:function(){var a=this,b;c("#J_PlayNext").on("click",function(){a.bringRest();b=c(".is-playing").next(".J_MusicItem");if(!b)return!1;b.addClass("is-playing").siblings(".J_MusicItem").removeClass("is-playing");a.bringRest();f&&f.cancel();e.id=b.attr("data-id");e.src=b.attr("data-url");a.render();a.updateProgress();c("#J_PlaySwitch").removeClass("pl-pause").addClass("pl-play")});
return this},playPrev:function(){var a=this,b;c("#J_PlayLast").on("click",function(){a.bringRest();b=c(".is-playing").prev(".J_MusicItem");if(!b)return!1;b.addClass("is-playing").siblings(".J_MusicItem").removeClass("is-playing");a.bringRest();f&&f.cancel();e.id=b.attr("data-id");e.src=b.attr("data-url");a.render();a.updateProgress();c("#J_PlaySwitch").removeClass("pl-pause").addClass("pl-play")});return this},_startPlay:function(){var a=this,b=c("#J_PlaySwitch");a.play(function(){a.updateProgress();
b.replaceClass("pl-pause","pl-play")})},_endMusic:function(){c(player).on("ended",function(){c("#J_PlayNext").fire("click")})},_setProgress:function(){var a=this;c("#J_PlayBar").on("click",function(b){a.progress(b.offsetX/a.getWindowWidth()*a.getTotalTime());a._changeProgress()})},_dragProgress:function(){var a=this,b=c("#J_Drag");a._createDD(b).on("drag",function(){var c=b.css("left");b.css("left",c);a.progress((parseFloat(c,10)+3)/a.getWindowWidth()*a.getTotalTime());a._changeProgress()})},_createDD:function(a){return new p.Draggable({node:a,
cursor:"move",move:!0,plugins:[new q({constrain:"#J_BarBack"})]})},_pointMusic:function(){var a=this;c(".J_MusicItem").on(j.Gesture.doubleTap,function(b){b=c(b.target);e.id=b.attr("data-id");e.src=b.attr("data-url");b.addClass("is-playing").siblings(".J_MusicItem").removeClass("is-playing");a.bringRest();f&&f.cancel();a.render(!0);c("#J_PlaySwitch").replaceClass("pl-pause","pl-play")})},isIOS:function(){var a=navigator.userAgent.toLowerCase();if(0<a.indexOf("iphone")||0<a.indexOf("ipod")||0<a.indexOf("ipad")||
0<a.indexOf("symbianos")||0<a.indexOf("ios"))return!0},fillList:function(){var a=localStorage.getItem("MUSIC_LIST")?localStorage.getItem("MUSIC_LIST").split(","):[];a.unshift(e.id);var b=d.unique(a),f=[];d.each(b,function(a,e){var g={id:a};d.io({type:"get",url:"http://test.fem.taobao.net:3000/song/"+a,dataType:"jsonp",success:function(a){g=d.mix(g,a);f.push(d.substitute('<li class="J_MusicItem" id="J_MusicItem{id}" data-url="{location}" data-id="{id}"><p class="bar J_PlListBar" class="J_ItemBar"></p><p class="pl-name">\t<strong class="tt" title="{title}">\t\t{title}\t</strong>\t<em>正在播放</em></p></li>',
g));e===b.length-1&&(c("#J_PlMusicList").html(f.join("")),n.sync(),h._changeColor(),h._pointMusic())},error:function(){d.log("error")}})});return this},_bindTabSwitch:function(){c("#J_PlListTab").css("left",c(window).width());c("#J_PlImgTab").css("left",0).show();var a=this;j.delegate(document,j.Gesture.tap,".J_PlayTabIcon",function(b){b=c(b.target);b=parseInt(b.attr("data-index"),10);a.switchTab(b)});c("#J_PlImgTab").on("swipe",function(b){"left"===b.direction&&a.switchTab(1)});c("#J_PlListTab").on("swipe",
function(b){"right"===b.direction&&a.switchTab(0)})},_changeColor:function(){var a=this;c(".J_MusicItem").each(function(b,c){var d=b.children(".pl-name").children(".tt"),e=d.text();400>a.getWindowWidth()&&(e=e.substr(0,12),d.html(e));if(0===c)return b.addClass("is-playing");1===c%2&&b.addClass("odd")})},switchTab:function(a){var b=c(window).width();c("#J_PlayerTab");var d=[c("#J_PlImgTab"),c("#J_PlListTab")],e=[c("#J_TabImg"),c("#J_TabList")],b=[0,b];d[a].show();d[0].animate({left:"-"+b[a]},0.5,void 0,
function(){});d[1].animate({left:b[1-a]},0.5,void 0,function(){d[1-a].hide();e[a].addClass("pl-hover");e[1-a].removeClass("pl-hover")});return this}});return h},{requires:"node,./index,event,../header,dd,dd/plugin/constrain,scrollview,scrollview/plugin/scrollbar,./player.css".split(",")});
