KISSY.add("xiami/transition/newplayer",function(f,s,z,k,o,t,u,v,w){var b=s.all,m,n=this.getName(),x=b("#body"),i={},d=null,j=null,g={},p=0,q=!1,l=null,h=0,e=localStorage.getItem("MY_MUSIC_LIST")?f.JSON.parse(localStorage.getItem("MY_MUSIC_LIST")):[];f.Player=new f.Base;f.mix(i,{init:function(){o.setTitle("播放器");p=0;m?f.log(n+" is coming again"):(m=b('<div class="mod-page"></div>').appendTo(x),m.html('<div id="J_PlTabContent" class="pl-tab-content">\t<div id="J_PlayerTab" class="pl-player-tab">\t\t<div class="pl-img-tab" id="J_PlImgTab">\t\t\t<div class="pl-img-content">\t\t\t\t<img class="pl-img" id="J_PlImg" src="http://img04.taobaocdn.com/tps/i4/T1mAOLXtXgXXbTIWs3-128-128.gif" alt="img">\t\t\t</div>\t\t\t</div>\t\t<div class="pl-list-tab" id="J_PlListTab" style="display:none;">\t\t\t<div class="ks-scrollview-content ks-content">\t\t\t<ul class="pl-music-list" id="J_PlMusicList">\t\t\t</ul>\t\t\t</div>\t\t</div>\t</div></div><div id="J_PlayInfo" class="pl-play-info">\t<ul class="pl-tab-icon" id="J_TabHandle">\t\t<li id="J_TabImg" data-index="0" class="J_PlayTabIcon pl-hover">\t\t</li>\t\t<li id="J_TabList" data-index="1" class="J_PlayTabIcon">\t\t</li>\t</ul>\t<p id="J_PlayTime" class="pl-play-time">\t\t<em id="J_CurrentTime" class="pl-current">\t\t\t00:00\t\t</em>\t\t<em id="J_TotalTime" class="pl-total">\t\t\t00:00\t\t</em>\t</p>\t<div id="J_PlayBar" class="pl-play-bar">\t\t<p id="J_PlayProgress" class="pl-progress"></p>\t\t<em id="J_PlayBarIcon" class="pl-bar-icon"></em>\t</div>\t<div class="pl-player-handle">\t\t<span id="J_PlayLast" class="pl-last">\t\t\t<em>last</em>\t\t</span>\t\t<span id="J_PlaySwitch" class="pl-switch pl-pause">\t\t\t<em>play/pause</em>\t\t</span>\t\t<span id="J_PlayNext" class="pl-next">\t\t\t<em>next</em>\t\t</span>\t</div></div>'),
f.log(n+" is new"));var a=b("#J_PlayInfo").height(),c=b(window).height()-a-45;b(window).width();console.log(b(window).height()+" "+a);b("#J_PlayerTab").height(c);b("#J_PlImg").css({"margin-top":(c-185-16)/2+"px"});if(!d)if(0!==e.length)g=f.clone(e[0]),this.playSong(),h=0;else{alert("当前播放列表为空，您可以返回试听歌曲噢！");return}this.updateMusicControl();this.updateMusicInfoTab();this.updateMusicListTab();q||(this._bindEvent(),q=!0);a=o.getHeader(n);a.contents().length||a.append(n)},getEl:function(){return m},_bindEvent:function(){this._bindTabSwitch();
this._bindControl();this._bindProgressAnyPosition();this._bindPlayNext();this._bindPlayPrev();this._bindDoubleTap()},render:function(a){var c=this;d&&d.pause();this.getMusicInfo(g.id,function(){c.createAudio(g.location,a);b("#J_PlImg").attr("src",g.albumCover)});return this},createAudio:function(a,c){d=new Audio;d.src=a;d.load();this._switchMusic();if(this.isIOS())b("#J_TotalTime").html("4:02");else{b("#J_TotalTime").html("loading");var y=f.later(function(){i.getTotalTime()&&(i._changeProgress(),
i._setProgress(),y.cancel())},200,!0)}c&&this.play();p++;return d},getAudio:function(){return d},stop:function(a){d&&d.pause();a&&a();return this},play:function(a){d.play();a&&a();return this},getTotalTime:function(){return d&&d.duration},bringRest:function(){d&&(d.pause(),d.currentTime&&(d.currentTime=0),j&&j.cancel(),b("#J_CurrentTime").html("0:00"),b("#J_PlayProgress").css("width",0),b("#J_PlayBarIcon").css("left",0),b("#J_PlaySwitch").replaceClass("pl-play","pl-pause"),d=null);return this},getMusicInfo:function(a,
c){f.io({type:"get",url:"http://test.fem.taobao.net:3000/song/"+a,dataType:"jsonp",success:function(b){f.mix(g,b);g.id=a;c()},error:function(){alert("error");c&&c()}});return this},updateProgress:function(a){j=f.later(function(){i._changeProgress()},a||200,!0);return this},getWindowWidth:function(){return b(window).width()},_changeProgress:function(){var a=b("#J_PlayProgress"),c=b("#J_CurrentTime"),d=b("#J_TotalTime"),e=b("#J_PlayBarIcon"),f=b("#J_MusicItem"+g.id),r=this.progress(),i=this.getTotalTime(),
h=r/i*this.getWindowWidth();a.css({width:h});0!==f.length&&f.children(".J_PlListBar").css({width:h});e.css({left:h>this.getWindowWidth()-8?this.getWindowWidth()-8:h});c.html(this.formatTime(r));d.html(this.formatTime(i))},formatTime:function(a){var c=Math.floor(a%60);9>=c&&(c="0"+c);return Math.floor(a/60)+":"+c},progress:function(a){return a?(d.currentTime=a,this):d.currentTime},_switchMusic:function(){var a=this,c;b("#J_PlaySwitch").detach("click").on("click",function(){c=b(this);c.hasClass("pl-pause")?
a._startPlay():a.stop(function(){j&&j.cancel();c.replaceClass("pl-play","pl-pause")})})},playNext:function(){var a=this,c;b("#J_PlayNext").on("click",function(){a.bringRest();(c=b(".is-playing").next(".J_MusicItem"))&&c.fire(k.Gesture.doubleTap);a.isIOS()?b("#J_PlaySwitch").removeClass("pl-play").addClass("pl-pause"):b("#J_PlaySwitch").removeClass("pl-pause").addClass("pl-play")});return this},playPrev:function(){var a=this,c;b("#J_PlayLast").on("click",function(){a.bringRest();(c=b(".is-playing").prev(".J_MusicItem"))&&
c.fire(k.Gesture.doubleTap);a.isIOS()?b("#J_PlaySwitch").removeClass("pl-play").addClass("pl-pause"):b("#J_PlaySwitch").removeClass("pl-pause").addClass("pl-play")});return this},_startPlay:function(){var a=this,c=b("#J_PlaySwitch");a.play(function(){a.updateProgress();c.replaceClass("pl-pause","pl-play")})},_endMusic:function(){b(d).on("ended",function(){b("#J_PlayNext").fire("click")})},_bindProgressAnyPosition:function(){var a=this;b("#J_PlayBar").on("click",function(c){a.progress(c.offsetX/a.getWindowWidth()*
a.getTotalTime());a._changeProgress()})},_dragProgress:function(){var a=this,c=b("#J_Drag");a._createDD(c).on("drag",function(){var b=c.css("left");c.css("left",b);a.progress((parseFloat(b,10)+3)/a.getWindowWidth()*a.getTotalTime());a._changeProgress()})},_createDD:function(a){return new t.Draggable({node:a,cursor:"move",move:!0,plugins:[new u({constrain:"#J_BarBack"})]})},_pointMusic:function(){var a=this;b(".J_MusicItem").on(k.Gesture.doubleTap,function(c){c=b(c.target);g.id=c.attr("data-id");c.addClass("is-playing").siblings(".J_MusicItem").removeClass("is-playing");
a.bringRest();j&&j.cancel();a.render(!0);b("#J_PlaySwitch").replaceClass("pl-pause","pl-play")})},isIOS:function(){var a=navigator.userAgent.toLowerCase();if(0<a.indexOf("iphone")||0<a.indexOf("ipod")||0<a.indexOf("ipad")||0<a.indexOf("symbianos")||0<a.indexOf("ios"))return!0},fillList:function(){var a=localStorage.getItem("MY_MUSIC_LIST")?localStorage.getItem("MY_MUSIC_LIST").split(","):[];a.unshift(g.id);var c=f.unique(a),d=[];f.each(c,function(a,e){var g={id:a};f.io({type:"get",url:"http://test.fem.taobao.net:3000/song/"+
a,dataType:"jsonp",success:function(a){g=f.mix(g,a);d.push(f.substitute('<li class="J_MusicItem" id="J_MusicItem{id}" data-id="{id}"><p class="bar J_PlListBar" class="J_ItemBar"></p><p class="pl-name">\t<strong class="tt" title="{title}">\t\t{title}\t</strong>\t<em>正在播放</em></p></li>',g));e===c.length-1&&(b("#J_PlMusicList").html(d.join("")),l.sync(),i._changeColor(),i._pointMusic())},error:function(){f.log("error")}})});return this},_bindTabSwitch:function(){b("#J_PlListTab").css("left",b(window).width());
var a=this;b(".J_PlayTabIcon").on("click",function(c){c=b(c.target);c=parseInt(c.attr("data-index"),10);a.switchTab(c)});b("#J_PlImgTab").on("swipe",function(c){"left"===c.direction&&a.switchTab(1)});b("#J_PlListTab").on("swipe",function(c){"right"===c.direction&&a.switchTab(0)})},_changeColor:function(){b(".J_MusicItem").each(function(a,c){if(c===h)return a.addClass("is-playing");1===c%2&&a.addClass("odd")})},switchTab:function(a){var c=b(window).width();b("#J_PlayerTab");var d=[b("#J_PlImgTab"),
b("#J_PlListTab")],e=[b("#J_TabImg"),b("#J_TabList")],c=[0,c];d[a].show();d[0].animate({left:"-"+c[a]},0.5,void 0,function(){});d[1].animate({left:c[1-a]},0.5,void 0,function(){d[1-a].hide();e[a].addClass("pl-hover");e[1-a].removeClass("pl-hover")});return this},addToList:function(a){f.isArray(a)||(a=[a]);var c=e.length,b,d;for(b=0;b<a.length;b++){for(d=0;d<c&&e[d].id!==a[b].id;d++);if(d===c)if(a[b].location)console.log(f.JSON.stringify(a[b])),e.push(a[b]),localStorage.setItem("MY_MUSIC_LIST",f.JSON.stringify(e));
else{var g=a[b].id;f.io({type:"get",url:"http://test.fem.taobao.net:3000/song/"+g,dataType:"jsonp",success:function(a){e.push({id:g,title:a.title,albumCover:a.albumCover,location:a.location});localStorage.setItem("MY_MUSIC_LIST",f.JSON.stringify(e))},error:function(){alert("error")}})}}},playSongNow:function(a){for(var b=this,d=0;d<e.length&&e[d].id!==a.id;d++);d===e.length?a.location?(g=a,e.push(f.clone(g)),localStorage.setItem("MY_MUSIC_LIST",f.JSON.stringify(e)),h=e.length-1,b.playSong()):b.getMusicInfo(a.id,
function(){e.push({id:g.id,title:g.title,albumCover:g.albumCover,location:g.location});localStorage.setItem("MY_MUSIC_LIST",f.JSON.stringify(e));h=e.length-1;b.playSong()}):(g=f.clone(e[d]),h=d,b.playSong())},playSong:function(){var a=this;d||(d=new Audio,d.addEventListener("ended",function(){a._bringRest();a.playSongNow(e[(h+1)%e.length]);a.updateMusicControl();a.updateMusicInfoTab();a.updateCurrentInMusicList()}));d.src=g.location;d.load();d.play();f.Player.fire("playSong",{musicInfo:g})},updateMusicControl:function(){d.paused?
(b("#J_PlaySwitch").removeClass("pl-play").addClass("pl-pause"),this._changeProgress()):(b("#J_PlaySwitch").removeClass("pl-pause").addClass("pl-play"),this._changeProgress(),this.updateProgress())},updateMusicInfoTab:function(){b("#J_PlImg").attr("src",g.albumCover);o.setTitle(g.title)},updateMusicListTab:function(){for(var a=[],c=0;c<e.length;c++)a.push(f.substitute('<li class="J_MusicItem" id="J_MusicItem{id}" data-id="{id}"><p class="bar J_PlListBar" class="J_ItemBar"></p><p class="pl-name">\t<strong class="tt" title="{title}">\t\t{title}\t</strong>\t<em>正在播放</em></p></li>',
e[c]));b("#J_PlMusicList").html(a.join(""));l||(l=l=(new v({srcNode:"#J_PlListTab",plugins:[new w({})]})).render());f.later(function(){l.sync()},3E3);this._changeColor()},_bindControl:function(){b("#J_PlaySwitch").detach("click").on("click",function(){var a=b("#J_PlaySwitch");a.hasClass("pl-play")&&d&&!d.paused?(a.removeClass("pl-play").addClass("pl-pause"),d.pause()):a.hasClass("pl-pause")&&d&&d.paused&&(a.removeClass("pl-pause").addClass("pl-play"),d.play())})},_bindPlayNext:function(){var a=this;
b("#J_PlayNext").on("click",function(b){b.halt();a._bringRest();a.playSongNow(e[(h+1)%e.length]);a.updateMusicControl();a.updateMusicInfoTab();a.updateCurrentInMusicList()});return this},_bindPlayPrev:function(){var a=this;b("#J_PlayLast").on("click",function(b){b.halt();a._bringRest();a.playSongNow(e[(h+e.length-1)%e.length]);a.updateMusicControl();a.updateMusicInfoTab();a.updateCurrentInMusicList()});return this},_bringRest:function(){d&&(d.pause(),d.currentTime&&(d.currentTime=0),b("#J_CurrentTime").html("0:00"),
b("#J_TotalTime").html("0:00"),b("#J_PlayProgress").css("width",0),b("#J_PlayBarIcon").css("left",0),b("#J_PlaySwitch").removeClass("pl-play").addClass("pl-pause"));return this},updateCurrentInMusicList:function(){b("#J_MusicItem"+g.id).addClass(".is-playing").siblings().removeClass(".is-playing")},_bindDoubleTap:function(){var a=this;k.delegate("#J_PlMusicList",k.Gesture.doubleTap,".J_MusicItem",function(c){for(var c=b(c.target).attr("data-id"),d=0;d<e.length;d++)e[d].id===c&&(a.playSongNow(e[d]),
a.updateMusicControl(),a.updateMusicInfoTab(),a.updateCurrentInMusicList())})}});return i},{requires:"node,./index,event,../header,dd,dd/plugin/constrain,scrollview,scrollview/plugin/scrollbar,./player.css".split(",")});
