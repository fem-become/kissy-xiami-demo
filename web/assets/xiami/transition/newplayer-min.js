KISSY.add("xiami/transition/newplayer",function(f,r,y,l,o,s,t,u,v){var c=r.all,m,n=this.getName(),w=c("#body"),j={},d=null,h=null,g={},p=0,q=!1,k=null,i=0,e=localStorage.getItem("MY_MUSIC_LIST")?f.JSON.parse(localStorage.getItem("MY_MUSIC_LIST")):[];f.Player=new f.Base;f.mix(j,{init:function(){o.setTitle("播放器");p=0;m?f.log(n+" is coming again"):(m=c('<div class="mod-page"></div>').appendTo(w),m.html('<div id="J_PlTabContent" class="pl-tab-content">\t<div id="J_PlayerTab" class="pl-player-tab">\t\t<div class="pl-img-tab" id="J_PlImgTab">\t\t\t<div class="pl-img-content">\t\t\t\t<img class="pl-img" id="J_PlImg" src="http://img04.taobaocdn.com/tps/i4/T1mAOLXtXgXXbTIWs3-128-128.gif" alt="img">\t\t\t</div>\t\t\t</div>\t\t<div class="pl-list-tab" id="J_PlListTab" style="display:none;">\t\t\t<div class="ks-scrollview-content ks-content">\t\t\t<ul class="pl-music-list" id="J_PlMusicList">\t\t\t</ul>\t\t\t</div>\t\t</div>\t</div></div><div id="J_PlayInfo" class="pl-play-info">\t<ul class="pl-tab-icon" id="J_TabHandle">\t\t<li id="J_TabImg" data-index="0" class="J_PlayTabIcon pl-hover">\t\t</li>\t\t<li id="J_TabList" data-index="1" class="J_PlayTabIcon">\t\t</li>\t</ul>\t<p id="J_PlayTime" class="pl-play-time">\t\t<em id="J_CurrentTime" class="pl-current">\t\t\t00:00\t\t</em>\t\t<em id="J_TotalTime" class="pl-total">\t\t\t00:00\t\t</em>\t</p>\t<div id="J_PlayBar" class="pl-play-bar">\t\t<p id="J_PlayProgress" class="pl-progress"></p>\t\t<em id="J_PlayBarIcon" class="pl-bar-icon"></em>\t</div>\t<div class="pl-player-handle">\t\t<span id="J_PlayLast" class="pl-last">\t\t\t<em>last</em>\t\t</span>\t\t<span id="J_PlaySwitch" class="pl-switch pl-pause">\t\t\t<em>play/pause</em>\t\t</span>\t\t<span id="J_PlayNext" class="pl-next">\t\t\t<em>next</em>\t\t</span>\t</div></div>'),
f.log(n+" is new"));var a=c("#J_PlayInfo").height(),b=c(window).height()-a-45;c(window).width();console.log(c(window).height()+" "+a);c("#J_PlayerTab").height(b);c("#J_PlImg").css({"margin-top":(b-185-16)/2+"px"});if(!d)if(0!==e.length)g=f.clone(e[0]),this.playSong(),i=0;else{alert("当前播放列表为空，您可以返回试听歌曲噢！");return}this.updateMusicControl();this.updateMusicInfoTab();this.updateMusicListTab();q||(this._bindEvent(),q=!0);a=o.getHeader(n);a.contents().length||a.append(n)},getEl:function(){return m},_bindEvent:function(){this._bindTabSwitch();
this._bindControl();this._bindProgressAnyPosition();this._bindPlayNext();this._bindPlayPrev();this._bindDoubleTap()},render:function(a){var b=this;d&&d.pause();this.getMusicInfo(g.id,function(){b.createAudio(g.location,a);c("#J_PlImg").attr("src",g.albumCover)});return this},createAudio:function(a,b){d=new Audio;d.src=a;d.load();this._switchMusic();if(this.isIOS())c("#J_TotalTime").html("4:02");else{c("#J_TotalTime").html("loading");var x=f.later(function(){j.getTotalTime()&&(j._changeProgress(),
j._setProgress(),x.cancel())},200,!0)}b&&this.play();p++;return d},getAudio:function(){return d},stop:function(a){d&&d.pause();a&&a();return this},play:function(a){d.play();a&&a();return this},getTotalTime:function(){return d&&d.duration},bringRest:function(){d&&(d.pause(),d.currentTime&&(d.currentTime=0),h&&h.cancel(),c("#J_CurrentTime").html("0:00"),c("#J_PlayProgress").css("width",0),c("#J_PlayBarIcon").css("left",0),c("#J_PlaySwitch").replaceClass("pl-play","pl-pause"),d=null);return this},getMusicInfo:function(a,
b){f.io({type:"get",url:"http://test.fem.taobao.net:3000/song/"+a,dataType:"jsonp",success:function(c){f.mix(g,c);g.id=a;b()},error:function(){alert("error");b&&b()}});return this},updateProgress:function(a){h=f.later(function(){j._changeProgress()},a||200,!0);return this},getWindowWidth:function(){return c(window).width()},_changeProgress:function(){var a=c("#J_PlayProgress"),b=c("#J_CurrentTime"),d=c("#J_TotalTime"),f=c("#J_PlayBarIcon"),e=c("#J_MusicItem"+g.id),i=this.progress(),j=this.getTotalTime(),
h=i/j*this.getWindowWidth();a.css({width:h});0!==e.length&&e.children(".J_PlListBar").css({width:h});f.css({left:h>this.getWindowWidth()-8?this.getWindowWidth()-8:h});b.html(this.formatTime(i));d.html(this.formatTime(j))},formatTime:function(a){var b=Math.floor(a%60);9>=b&&(b="0"+b);return Math.floor(a/60)+":"+b},progress:function(a){return a?(d.currentTime=a,this):d.currentTime},_switchMusic:function(){var a=this,b;c("#J_PlaySwitch").detach("click").on("click",function(){b=c(this);b.hasClass("pl-pause")?
a._startPlay():a.stop(function(){h&&h.cancel();b.replaceClass("pl-play","pl-pause")})})},playNext:function(){var a=this,b;c("#J_PlayNext").on("click",function(){a.bringRest();(b=c(".is-playing").next(".J_MusicItem"))&&b.fire(l.Gesture.doubleTap);a.isIOS()?c("#J_PlaySwitch").removeClass("pl-play").addClass("pl-pause"):c("#J_PlaySwitch").removeClass("pl-pause").addClass("pl-play")});return this},playPrev:function(){var a=this,b;c("#J_PlayLast").on("click",function(){a.bringRest();(b=c(".is-playing").prev(".J_MusicItem"))&&
b.fire(l.Gesture.doubleTap);a.isIOS()?c("#J_PlaySwitch").removeClass("pl-play").addClass("pl-pause"):c("#J_PlaySwitch").removeClass("pl-pause").addClass("pl-play")});return this},_startPlay:function(){var a=this,b=c("#J_PlaySwitch");a.play(function(){a.updateProgress();b.replaceClass("pl-pause","pl-play")})},_endMusic:function(){c(d).on("ended",function(){c("#J_PlayNext").fire("click")})},_bindProgressAnyPosition:function(){var a=this;c("#J_PlayBar").on("click",function(b){a.progress(b.offsetX/a.getWindowWidth()*
a.getTotalTime());a._changeProgress()})},_dragProgress:function(){var a=this,b=c("#J_Drag");a._createDD(b).on("drag",function(){var c=b.css("left");b.css("left",c);a.progress((parseFloat(c,10)+3)/a.getWindowWidth()*a.getTotalTime());a._changeProgress()})},_createDD:function(a){return new s.Draggable({node:a,cursor:"move",move:!0,plugins:[new t({constrain:"#J_BarBack"})]})},_pointMusic:function(){var a=this;c(".J_MusicItem").on(l.Gesture.doubleTap,function(b){b=c(b.target);g.id=b.attr("data-id");b.addClass("is-playing").siblings(".J_MusicItem").removeClass("is-playing");
a.bringRest();h&&h.cancel();a.render(!0);c("#J_PlaySwitch").replaceClass("pl-pause","pl-play")})},isIOS:function(){var a=navigator.userAgent.toLowerCase();if(0<a.indexOf("iphone")||0<a.indexOf("ipod")||0<a.indexOf("ipad")||0<a.indexOf("symbianos")||0<a.indexOf("ios"))return!0},fillList:function(){var a=localStorage.getItem("MY_MUSIC_LIST")?localStorage.getItem("MY_MUSIC_LIST").split(","):[];a.unshift(g.id);var b=f.unique(a),d=[];f.each(b,function(a,e){var g={id:a};f.io({type:"get",url:"http://test.fem.taobao.net:3000/song/"+
a,dataType:"jsonp",success:function(a){g=f.mix(g,a);d.push(f.substitute('<li class="J_MusicItem" id="J_MusicItem{id}" data-id="{id}"><p class="bar J_PlListBar" class="J_ItemBar"></p><p class="pl-name">\t<strong class="tt" title="{title}">\t\t{title}\t</strong>\t<em>正在播放</em></p></li>',g));e===b.length-1&&(c("#J_PlMusicList").html(d.join("")),k.sync(),j._changeColor(),j._pointMusic())},error:function(){f.log("error")}})});return this},_bindTabSwitch:function(){c("#J_PlListTab").css("left",c(window).width());
var a=this;c(".J_PlayTabIcon").on("click",function(b){b=c(b.target);b=parseInt(b.attr("data-index"),10);a.switchTab(b)});c("#J_PlImgTab").on("swipe",function(b){"left"===b.direction&&a.switchTab(1)});c("#J_PlListTab").on("swipe",function(b){if("right"===b.direction)a.switchTab(0);else if("left"===b.direction&&(b.halt(),b=c(b.target),b.hasClass("J_MusicItem")||(b=b.parent(".J_MusicItem")),b&&0!==b.length)){var d=b.attr("data-id"),h=b.index(".J_MusicItem");d===g.id?alert("不能删除当前播放歌曲噢"):(h<i&&i--,b.remove(),
e.splice(h,1),f.later(function(){k.sync()},0),localStorage.setItem("MY_MUSIC_LIST",f.JSON.stringify(e)))}})},_changeColor:function(){c(".J_MusicItem").each(function(a,b){if(b===i)return a.addClass("is-playing")})},switchTab:function(a){var b=c(window).width();c("#J_PlayerTab");var d=[c("#J_PlImgTab"),c("#J_PlListTab")],e=[c("#J_TabImg"),c("#J_TabList")],b=[0,b];d[a].show();d[0].animate({left:"-"+b[a]},0.5,void 0,function(){});d[1].animate({left:b[1-a]},0.5,void 0,function(){d[1-a].hide();e[a].addClass("pl-hover");
e[1-a].removeClass("pl-hover")});return this},addToList:function(a){f.isArray(a)||(a=[a]);var b=e.length,c,d;for(c=0;c<a.length;c++){for(d=0;d<b&&e[d].id!==a[c].id;d++);if(d===b)if(a[c].location)console.log(f.JSON.stringify(a[c])),e.push(a[c]),localStorage.setItem("MY_MUSIC_LIST",f.JSON.stringify(e));else{var g=a[c].id;f.io({type:"get",url:"http://test.fem.taobao.net:3000/song/"+g,dataType:"jsonp",success:function(a){e.push({id:g,title:a.title,albumCover:a.albumCover,location:a.location});localStorage.setItem("MY_MUSIC_LIST",
f.JSON.stringify(e))},error:function(){alert("error")}})}}},playSongNow:function(a){for(var b=this,c=0;c<e.length&&e[c].id!==a.id;c++);c===e.length?a.location?(g=a,e.push(f.clone(g)),localStorage.setItem("MY_MUSIC_LIST",f.JSON.stringify(e)),i=e.length-1,b.playSong()):b.getMusicInfo(a.id,function(){e.push({id:g.id,title:g.title,albumCover:g.albumCover,location:g.location});localStorage.setItem("MY_MUSIC_LIST",f.JSON.stringify(e));i=e.length-1;b.playSong()}):(g=f.clone(e[c]),i=c,b.playSong())},playSong:function(){var a=
this;d||(d=new Audio,d.addEventListener("ended",function(){a._bringRest();a.playSongNow(e[(i+1)%e.length]);a.updateMusicControl();a.updateMusicInfoTab();a.updateCurrentInMusicList()}));d.src=g.location;d.load();d.play();f.Player.fire("playSong",{musicInfo:g})},updateMusicControl:function(){d.paused?(c("#J_PlaySwitch").removeClass("pl-play").addClass("pl-pause"),this._changeProgress()):(c("#J_PlaySwitch").removeClass("pl-pause").addClass("pl-play"),this._changeProgress(),this.updateProgress())},updateMusicInfoTab:function(){c("#J_PlImg").attr("src",
g.albumCover);o.setTitle(g.title)},updateMusicListTab:function(){for(var a=[],b=0;b<e.length;b++)a.push(f.substitute('<li class="J_MusicItem" id="J_MusicItem{id}" data-id="{id}"><p class="bar J_PlListBar" class="J_ItemBar"></p><p class="pl-name">\t<strong class="tt" title="{title}">\t\t{title}\t</strong>\t<em>正在播放</em></p></li>',e[b]));c("#J_PlMusicList").html(a.join(""));k?f.later(function(){k.sync()},0):(k=k=(new u({srcNode:"#J_PlListTab",plugins:[new v({})]})).render(),f.later(function(){k.sync()},
2500));this._changeColor()},_bindControl:function(){c("#J_PlaySwitch").detach("click").on("click",function(){var a=c("#J_PlaySwitch");a.hasClass("pl-play")&&d&&!d.paused?(a.removeClass("pl-play").addClass("pl-pause"),d.pause()):a.hasClass("pl-pause")&&d&&d.paused&&(a.removeClass("pl-pause").addClass("pl-play"),d.play())})},_bindPlayNext:function(){var a=this;c("#J_PlayNext").on("click",function(b){b.halt();a._bringRest();a.playSongNow(e[(i+1)%e.length]);a.updateMusicControl();a.updateMusicInfoTab();
a.updateCurrentInMusicList()});return this},_bindPlayPrev:function(){var a=this;c("#J_PlayLast").on("click",function(b){b.halt();a._bringRest();a.playSongNow(e[(i+e.length-1)%e.length]);a.updateMusicControl();a.updateMusicInfoTab();a.updateCurrentInMusicList()});return this},_bringRest:function(){d&&(d.pause(),d.currentTime&&(d.currentTime=0),c("#J_CurrentTime").html("0:00"),c("#J_TotalTime").html("0:00"),c("#J_PlayProgress").css("width",0),c("#J_PlayBarIcon").css("left",0),c("#J_PlaySwitch").removeClass("pl-play").addClass("pl-pause"));
return this},updateCurrentInMusicList:function(){c("#J_MusicItem"+g.id).addClass(".is-playing").siblings().removeClass(".is-playing")},_bindDoubleTap:function(){var a=this;l.delegate("#J_PlMusicList",l.Gesture.doubleTap,".J_MusicItem",function(b){for(var b=c(b.target).attr("data-id"),d=0;d<e.length;d++)if(e[d].id===b){g=f.clone(e[d]);i=d;a.playSong();a.updateMusicControl();a.updateMusicInfoTab();a.updateCurrentInMusicList();break}})}});return j},{requires:"node,./index,event,../header,dd,dd/plugin/constrain,scrollview,scrollview/plugin/scrollbar,./player.css".split(",")});
