KISSY.add("xiami/transition/discover",function(c,z,q,G,r,A,B,C,p,x,v,D){var E=z.all,y=null,w=null,s=null,F=this.getName(),n,u="radar",o=0,l={sadness:[[{tag:"粤语",key:""},{tag:"民谣",key:""},{tag:"五月天",key:""}],[{tag:"伤感",key:""},{tag:"金属",key:""},{tag:"轻快",key:""}],[{tag:"励志",key:""},{tag:"温暖",key:""},{tag:"忧伤",key:""}],[{tag:"吉他",key:""},{tag:"怀旧",key:""},{tag:"纯音乐",key:""}],[{tag:"摇滚",key:""},{tag:"治愈",key:""},{tag:"舒服",key:""}]],happiness:[[{tag:"杨宗纬",key:""},{tag:"深情",key:""},{tag:"清新",key:""}],
[{tag:"节奏",key:""},{tag:"慵懒",key:""},{tag:"Rock",key:""}],[{tag:"电子",key:""},{tag:"钢琴",key:""},{tag:"韩国",key:""}],[{tag:"小提琴",key:""},{tag:"电音",key:""},{tag:"悠然自在",key:""}],[{tag:"爵士",key:""},{tag:"流行",key:""},{tag:"舒缓",key:""}]],calm:[[{tag:"抒情",key:""},{tag:"Electronic",key:""},{tag:"轻音乐",key:""}],[{tag:"Folk",key:""},{tag:"Jazz",key:""},{tag:"林志炫",key:""}],[{tag:"小清新",key:""},{tag:"Adele",key:""},{tag:"古风",key:""}],[{tag:"中国摇滚",key:""},{tag:"治愈系",key:""},{tag:"五月天",key:""}],[{tag:"粤语",key:""},
{tag:"民谣",key:""},{tag:"五月天",key:""}]],excite:[[{tag:"爵士",key:""},{tag:"小提琴",key:""},{tag:"舒缓",key:""}],[{tag:"林志炫",key:""},{tag:"小清新",key:""},{tag:"Adele",key:""}],[{tag:"流行",key:""},{tag:"吉他",key:""},{tag:"节奏",key:""}],[{tag:"金属",key:""},{tag:"摇滚",key:""},{tag:"劲爆",key:""}],[{tag:"中国摇滚",key:""},{tag:"电音",key:""},{tag:"Rock",key:""}]]},m=[{tag:"舒缓"},{tag:"爵士"},{tag:"抒情"},{tag:"治愈"},{tag:"怀旧"},{tag:"陈绮贞"},{tag:"流行"},{tag:"陈奕迅"},{tag:"吉他"},{tag:"慵懒"},{tag:"轻快"},{tag:"五月天"},{tag:"Adele"},{tag:"电子"},
{tag:"中国摇滚"},{tag:"Rock"},{tag:"节奏"},{tag:"金属"}];return{init:function(){n?c.log("discover music is coming again"):(n=E('<div class="mod-page"></div>').appendTo(body),n.html('<div class="display-area"><div class="radar-area center"><ul class="switch-way J_Switch"><li class="active"></li><li></li></ul><div class="panel J_RadarPanel"><canvas id="radar-canvas" class="opt-area"></canvas><div class="radar"><div class="radar-bg"></div><div class="radar-handler"></div></div><div id="message"><div class="mask"></div><div class="result-msg">发现15首好歌</div></div></div><div class="panel J_ShakePanel" style="display:none;"><div class="opt-area"><div class="battery-container"><div class="battery-energy"></div></div><div class="battery-anode"></div></div></div></div><\!-- end of .radar-area --\><div class="songs-area center"><div class="songs-list J_SongsList"><div class="ks-scrollview-content ks-content"><ul class="unstyled"></ul></div></div></div><\!-- end of .songs-area --\></div><\!-- end of .display-area --\><div class="illustration-area"><div class="radar-illustration center J_RadarIllus"><h2>音乐雷达</h2><p>移动滑块，根据您的心情发现音乐</p></div><div class="radar-illustration center J_ShakeIllus" style="display: none;"><h2>音乐摇摆引擎</h2><p>摇滚你的手机，根据节奏发现好音乐</p></div></div><\!-- end of .illustration-area --\><script type="text/template" id="songs-list-tpl">{{#each songs}}<li data-id="{{id}}">{{title}}<button class="play-btn"/><button class="addtolist-btn"/></li>{{/each}}<\/script>'),
this._drawCanvas(),this._bindEvent(),c.log("discover music is new"));var a=r.getHeader("discover");a.contents().length?r.setTitle("发现音乐"):a.html('<h1>发现音乐</h1><a href="#" class="list-icon icon">列表</a><a href="#" class="search-icon icon">搜索</a>');v.setCurrentMod(F)},getEl:function(){return n},_drawCanvas:function(){var a=c.one("#radar-canvas"),b=a[0].getContext("2d");width=a.width();height=a.height();LINE_WIDTH=2;PADDING=5;COLOR="#FFF";c.one(a).attr("width",width).attr("height",height);b.strokeStyle=
COLOR;b.fillStyle=COLOR;b.lineWidth=LINE_WIDTH;b.shadowColor="#8999b4";b.shadowBlur=0;b.shadowOffsetX=0;b.shadowOffsetY=-2;b.beginPath();b.moveTo(PADDING,height/2);b.lineTo(width-PADDING,height/2);b.stroke();b.shadowOffsetX=2;b.shadowOffsetY=0;b.beginPath();b.moveTo(width/2,PADDING);b.lineTo(width/2,height-PADDING);b.stroke();b.shadowOffsetX=b.shadowOffsetY=0;b.font="16px Times New Roman";b.fillText("忧伤",PADDING,height/2-3*LINE_WIDTH);b.textAlign="right";b.fillText("快乐",width-PADDING,height/2-3*LINE_WIDTH);
b.fillText("平静",width/2-2*LINE_WIDTH,PADDING+14);b.fillText("激动",width/2-2*LINE_WIDTH,height-2*PADDING)},_recommendSongsByRadar:function(a){var b=this,f=c.one("#radar-canvas"),d=f.width(),e=f.height(),f=a.x-d/2,a=a.y-e/2,e=e/2/5,d=Math.floor(Math.abs(f)/(d/2/5)),e=Math.floor(Math.abs(a)/e),f=0>f?l.sadness[d]:l.happiness[d],a=0>a?l.excite[e]:l.calm[e],f=f[Math.floor(Math.random()*f.length)],a=a[Math.floor(Math.random()*a.length)],i=!1,g=[];new p({type:"GET",url:"http://test.fem.taobao.net:3000/song/tag/"+
f.tag,dataType:"jsonp",crossDomain:!0,complete:function(a,c){"success"==c&&a.songs&&(g=g.concat(a.songs),i?b._showResult(g):i=!0)}});new p({type:"GET",url:"http://test.fem.taobao.net:3000/song/tag/"+a.tag,dataType:"jsonp",crossDomain:!0,complete:function(a,c){"success"==c&&a.songs&&(g=g.concat(a.songs),i?b._showResult(g):i=!0)}})},_updateEnergy:function(a){var b=c.one(".battery-energy"),f=c.one(".battery-anode"),a=a.time/a.count,a=200>a?1:600<a?0:1.5-a/400;o=1;b.css("width",100*a+"%");1===a?f.css("background",
"#90d5fe"):f.css("background","#cad0d3");return a},_recommendSongsByShake:function(a){c.one(".battery-energy");c.one(".battery-anode");a=this._updateEnergy(a);a=Math.floor(a*m.length);a===m.length&&(a=m.length-1);new p({type:"GET",url:"http://test.fem.taobao.net:3000/song/tag/"+m[a].tag,dataType:"jsonp",crossDomain:!0,complete:function(a,f){if("success"==f&&a.songs){var d=(new x(c.one("#songs-list-tpl").html())).render({songs:a.songs});c.one(".J_SongsList").one("ul").html(d).end().show();w.show().sync();
o=0}}})},_updateMsgPosition:function(){var a=c.one("#radar-canvas"),b=a.width(),a=a.height(),f=c.one(".radar"),d=f.offset(),e=d.left-c.one(".J_RadarPanel").offset().left,d=d.top-c.one(".J_RadarPanel").offset().top,i=f.width(),f=f.height(),g=c.one("#message"),h=Math.min(g.width(),g.height());Math.max(g.width(),g.height());var j=0,k=0;e+i+h-30<b&&0<=d&&d+f<a?(g.addClass("right"),j=e+i-30,k=d):0<e-h+30&&0<=d&&d+f<a?(g.addClass("left"),j=e-h+30,k=d):d+f+h-30<a&&0<=e&&e+i<b?(g.addClass("bottom"),j=e,k=
d+f-30):0<d-h+30&&0<=e&&e+i<b?(g.addClass("top"),j=e,k=d-h+30):e<b/2&&d<a/2?(g.addClass("lefttop").addClass("right"),j=e+i-30,k=d):e>b/2&&d<a/2?(g.addClass("righttop").addClass("left"),j=e-h+30,k=d):e<b/2&&d>a/2?(g.addClass("leftbottom").addClass("right"),j=e+i-30,k=d):e>b/2&&d>a/2&&(g.addClass("rightbottom").addClass("left"),j=e-h+30,k=d);g.css({left:j+"px",top:k+"px"})},_randomSort:function(){return 0.5<Math.random()?-1:1},_showResult:function(a){var b=this,b=(new x(c.one("#songs-list-tpl").html())).render({songs:a.sort(b._randomSort)});
c.one(".J_SongsList").one("ul").html(b).end().show();w.show().sync();var b=this,f=c.one(".radar"),d=c.one("#message");d.attr("class","");f.removeClass("detecting");clearTimeout(y);b._updateMsgPosition();d.one(".result-msg").text("发现"+a.length+"首好歌");d.show();s.set("disabled",!1)},_bindEvent:function(){var a=this,b=c.one(".radar"),f=c.one(".radar-bg");c.one(".radar-handler");var d=c.one("#message");s=new A.Draggable({node:".radar",handlers:[".radar-handler"],move:!0});var e=5,i=function(){f.css({"-webkit-transform":"rotate("+
e%360+"deg)","-moz-transform":"rotate("+e%360+"deg)",transform:"rotate("+e%360+"deg)"});e+=30;y=setTimeout(i,100)};s.on("dragstart",function(){d.hide();b.removeClass("active")});s.on("dragend",function(){var d=b.offset(),e=d.left-c.one(".J_RadarPanel").offset().left,d=d.top-c.one(".J_RadarPanel").offset().top,f=b.width(),g=b.height();b.addClass("active").addClass("detecting");s.set("disabled",!0);i();a._recommendSongsByRadar({x:e+f/2,y:d+g/2})});w=(new B({srcNode:".songs-list",plugins:[new C({})]})).render();
c.one(".J_SongsList").hide();var g=c.one(".J_ShakePanel"),h=c.one(".J_RadarPanel"),j=c.one(".J_ShakeIllus"),k=c.one(".J_RadarIllus"),n=c.one(".J_Switch"),l=h.width(),m=h.height(),p=function(){g.show();j.show();k.hide();h.animate({left:l},0.5,void 0,function(){g.css("top",0)});g.animate({left:0},0.5,void 0,function(){h.hide().css("top",0)});n.all("li").item(1).addClass("active").siblings().removeClass("active");c.one(".J_SongsList").one("ul").empty().end().hide();u="shake"},r=function(){h.show();g.css("top",
-m+"px");j.hide();k.show();g.animate({left:l},0.5,void 0,function(){h.css("top",0)});h.animate({left:0},0.5,void 0,function(){g.hide().css("top",-m+"px")});n.all("li").item(0).addClass("active").siblings().removeClass("active");c.one(".J_SongsList").one("ul").empty().end().hide();u="radar"};g.css({top:-m+"px",left:l});var t=new D;q.on(".display-area","swipe",function(a){"radar"===u&&"left"===a.direction?(p(),t.start()):"shake"===u&&"right"===a.direction?(r(),t.stop()):"up"===a.direction?window.scrollBy(0,
100):"down"===a.direction&&window.scrollBy(0,-100)});t.on("shakestart",function(){if(0===o){var a=c.one(".battery-energy"),b=c.one(".battery-anode");a.css("width","0");b.css("background","#cad0d3")}o^=1});t.on("shaking",function(b){1===o&&a._updateEnergy(b)});t.on("shakeend",function(b){1===o&&a._recommendSongsByShake.call(a,b)});q.delegate(".J_SongsList","click",".play-btn",function(a){a=c.one(a.target);v.playOne({id:a.parent("li").attr("data-id")})});q.delegate(".J_SongsList","click",".addtolist-btn",
function(a){a=c.one(a.target).parent("li").attr("data-id");v.addToList({id:a})});c.one(".J_Switch").all("li").each(function(a,b){if(0==b)a.on(q.Gesture.tap,function(){r()});else a.on(q.Gesture.tap,function(){p()})})}}},{requires:"node,event,./index,../header,dd,scrollview,scrollview/plugin/scrollbar,ajax,xtemplate,../suspender,./shake,./discover.css".split(",")});
