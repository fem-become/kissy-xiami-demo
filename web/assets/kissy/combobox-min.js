/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Mar 13 21:17
*/
KISSY.add("combobox/base",function(d,f,h,l,i,c){function b(g){var a;a=this.get("menu");g.target==a&&(g=a.get("el"),a=a.get("contentEl"),g.on("focusout",s,this),g.on("focusin",q,this),a.on("mouseover",e,this))}function a(g){var g=g.target,a=this;g.isMenuItem&&(g=g.get("textContent"),a._stopNotify=1,a.setValueInternal(g),a._savedInputValue=g,a.set("collapsed",!0),setTimeout(function(){a._stopNotify=0},50))}function e(){this.get("input")[0].focus();q.call(this)}function m(g,a){var b=g.get("el"),e=g.get("prefixCls")+
"combobox-invalid",c=g.get("invalidEl");a?(b.addClass(e),c.attr("title",a),c.show()):(b.removeClass(e),c.hide())}function j(g,a){var b=g.get("menu");if(b&&!b.isController)if(a)b=h.create(b,g),g.setInternal("menu",b);else return null;return b}function p(){var g=j(this);g&&g.get("visible")&&this.alignInternal()}function s(){var g=this;g._focusoutDismissTimer=setTimeout(function(){g.set("collapsed",!0)},30)}function q(){var g;if(g=this._focusoutDismissTimer)clearTimeout(g),this._focusoutDismissTimer=
null}function n(){var g;this._stopNotify||(g=this.getValueInternal(),g===c?this.set("collapsed",!0):(this._savedInputValue=g,this.sendRequest(g)))}function t(g){var a,b=[],e,c,m=j(this,1),g=this.normalizeData(g);m.removeChildren(!0);m.get("highlightedItem")&&m.get("highlightedItem").set("highlighted",!1);if(g&&g.length){for(c=0;c<g.length;c++)a=g[c],b.push(m.addChild(a));g=this.getValueInternal();for(c=0;c<b.length;c++)if(b[c].get("textContent")==g){b[c].set("highlighted",!0);e=!0;break}if(!e&&this.get("autoHighlightFirst"))for(c=
0;c<b.length;c++)if(!b[c].get("disabled")){b[c].set("highlighted",!0);break}this.set("collapsed",!1);p.call(this)}else this.set("collapsed",!0)}var o,i=f.all,k=f.KeyCodes,r={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},u=i(d.Env.host);return o=h.Controller.extend({_savedInputValue:null,_stopNotify:0,normalizeData:function(a){var b,e,c;if(a&&a.length){a=a.slice(0,this.get("maxItemCount"));b=this.get("format")?this.get("format").call(this,this.getValueInternal(),a):[];for(c=0;c<a.length;c++)e=
a[c],b[c]=d.mix({content:e,textContent:e,value:e},b[c])}return b},bindUI:function(){this.get("input").on("valuechange",n,this);this.on("click",a,this);u.on("resize",this.__repositionBuffer=d.buffer(p,50),this);this.on("afterRenderUI",b,this)},getValueInternal:function(){return this.get("input").val()},setValueInternal:function(a){this.get("input").val(a)},alignInternal:function(){var a=this.get("menu"),b=a.get("align");delete b.node;b=d.clone(b);b.node=this.get("el");d.mix(b,r,!1);a.set("align",b)},
handleFocus:function(){var a;m(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlur:function(){var a=this,b=a.get("placeholderEl"),e;o.superclass.handleBlur.apply(a,arguments);s.call(a);e=a.get("input");a.validate(function(b,c){b?!a.get("focused")&&c==e.val()&&m(a,b):m(a,!1)});b&&!e.val()&&b.show()},handleMouseDown:function(a){var b,e;o.superclass.handleMouseDown.apply(this,arguments);b=a.target;e=this.get("trigger");if(this.get("hasTrigger")&&(e[0]==b||e.contains(b)))b=this.get("input"),
this.get("collapsed")?(b[0].focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyEventInternal:function(a){var b,e,m;e=j(this);if(!e)return c;this.get("input");if(b=this.get("updateInputOnDownUp"))this._stopNotify=d.inArray(a.keyCode,[k.UP,k.DOWN,k.ESC])?1:0;if(e.get("visible")){m=e.handleKeydown(a);if(a.keyCode==k.ESC)return this.set("collapsed",!0),b&&this.setValueInternal(this._savedInputValue),!0;e=e.get("highlightedItem");b&&d.inArray(a.keyCode,[k.DOWN,k.UP])&&
this.setValueInternal(e.get("textContent"));return a.keyCode==k.TAB&&e&&(e.performActionInternal(),this.get("multiple"))?!0:m}return a.keyCode==k.DOWN||a.keyCode==k.UP?(this.sendRequest(this.getValueInternal()),!0):c},syncUI:function(){var a,b;this.get("placeholder")&&(a=this.get("input"),b=this.get("inputValue"),b!=c&&a.val(b),a.val()||this.get("placeholderEl").show())},validate:function(a){var b=this.get("validator"),e=this.get("input").val();b?b(e,function(b){a(b,e)}):a(!1,e)},sendRequest:function(a){this.get("dataSource").fetchData(a,
t,this)},_onSetCollapsed:function(a){if(a)(a=j(this))&&a.hide();else{var a=this.get("el"),b=j(this,1);q.call(this);b&&!b.get("visible")&&(this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),this.get("input").attr("aria-owns",b.get("el").attr("id")))}},destructor:function(){var a=this.__repositionBuffer;a&&(u.detach("resize",a,this),a.stop())}},{ATTRS:{input:{view:1},inputValue:{view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},
hasTrigger:{view:1},menu:{value:{},setter:function(a){a&&a.isController&&a.setInternal("parent",this)}},defaultChildCfg:{value:{xclass:"popupmenu"}},collapsed:{view:1},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},xrender:{value:l}}},{xclass:"combobox",priority:10})},{requires:["node","component/base","./render","menu"]});
KISSY.add("combobox",function(d,f,h,l,i,c){f.LocalDataSource=i;f.RemoteDataSource=c;f.FilterSelect=l;f.MultiValueComboBox=h;return f},{requires:["combobox/base","combobox/multi-value-combobox","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/cursor",function(d,f){function h(b){var a=i,e;a||(a=f.create(l));"textarea"==""+b.type?f.css(a,"width",f.css(b,"width")):f.css(a,"width",9999);d.each(c,function(e){f.css(a,e,f.css(b,e))});i||(e=b.ownerDocument.body,e.insertBefore(a,e.firstChild));return i=a}var l="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",i,c="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(b){var b=f.get(b),a=b.ownerDocument,e,c,j=b.scrollTop,p=b.scrollLeft;if(a.selection)return a=a.selection.createRange(),{left:a.boundingLeft+p+f.scrollLeft(),top:a.boundingTop+j+a.boundingHeight+f.scrollTop()};e=f.offset(b);if("textarea"!=b.type)return e.top+=b.offsetHeight,e;c=h(b);a=b.selectionStart;c.innerHTML=d.escapeHTML(b.value.substring(0,a-1))+"<span>x</span>";f.offset(c,e);e=c.lastChild;b=f.offset(e);b.top+=f.height(e);0<a&&(b.left+=f.width(e));b.top-=j;b.left-=p;return b}},
{requires:["dom"]});KISSY.add("combobox/filter-select",function(d,f){var h=f.extend({validate:function(f){var i=this;h.superclass.validate.call(i,function(c,b){c?f(c,b):i.get("dataSource").fetchData(b,function(a){a:{if(a=i.normalizeData(a))for(var e=0;e<a.length;e++)if(a[e].textContent==b){a=a[e];break a}a=!1}f(a?"":i.get("invalidMessage"),b,a)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return h},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(d){function f(){f.superclass.constructor.apply(this,arguments)}f.ATTRS={data:{value:[]},parse:{value:function(f,l){var i=[],c=0;if(!f)return l;d.each(l,function(b){-1!=b.indexOf(f)&&i.push(b);c++});return i}}};d.extend(f,d.Base,{fetchData:function(f,d,i){var c=this.get("parse"),b=this.get("data"),b=c(f,b);d.call(i,b)}});return f},{requires:["component/base"]});
KISSY.add("combobox/multi-value-combobox",function(d,f,h){function l(a,b){return b&&-1!=a.indexOf(b)}function i(a){var e=a.get("input"),f=e.val(),j=[],d=[],i=a.get("literal"),h=a.get("separator"),a=a.get("separatorType"),n=!1,t=a!=c,e=e.prop("selectionStart"),o,k,r=-1;for(o=0;o<f.length;o++)(k=f.charAt(o),i&&k==i&&(n=!n),n)?d.push(k):(o==e&&(r=j.length),t&&b.test(k))?(d.length&&j.push(d.join("")),d=[],d.push(k)):l(h,k)?a==c?(d.push(k),d.length&&j.push(d.join("")),d=[]):(d.length&&j.push(d.join("")),
d=[],d.push(k)):d.push(k);d.length&&j.push(d.join(""));j.length||j.push("");-1==r&&(a==c&&l(h,k)&&j.push(""),r=j.length-1);return{tokens:j,cursorPosition:e,tokenIndex:r}}var c="suffix",b=/\s|\xa0/;return h.extend({getValueInternal:function(){this.get("input");var a=i(this),b=a.tokens,d=a.tokenIndex,a=this.get("separator"),f=this.get("separatorType"),b=b[d],d=b.length-1;if(f!=c)if(l(a,b.charAt(0)))b=b.slice(1);else return;else f==c&&l(a,b.charAt(d))&&(b=b.slice(0,d));return b},setValueInternal:function(a){var e=
this.get("input"),d=i(this),f=d.tokens,d=Math.max(0,d.tokenIndex),h=this.get("separator"),s=this.get("separatorType"),q=f[d+1]||"",n=f[d];if(s!=c){if(f[d]=n.charAt(0)+a,!q||!b.test(q.charAt(0)))f[d]+=" "}else f[d]=a,a=n.length-1,l(h,n.charAt(a))?f[d]+=n.charAt(a):1==h.length&&(f[d]+=h);a=f.slice(0,d+1).join("").length;e.val(f.join(""));e.prop("selectionStart",a);e.prop("selectionEnd",a)},alignInternal:function(){if(this.get("alignWithCursor")){var a=i(this),b=a.tokens,c=this.get("menu"),d=a.cursorPosition,
l=a.tokenIndex,a=this.get("input"),b=b.slice(0,l).join("").length;0<b&&++b;a.prop("selectionStart",b);a.prop("selectionEnd",b);b=f(a);a.prop("selectionStart",d);a.prop("selectionEnd",d);c.set("xy",[b.left,b.top])}else h.prototype.alignInternal.apply(this,arguments)}},{ATTRS:{separator:{value:",;"},separatorType:{value:c},literal:{value:'"'},alignWithCursor:{}}},{xclass:"multi-value-combobox",priority:20})},{requires:["./cursor","./base"]});
KISSY.add("combobox/RemoteDataSource",function(d,f){function h(){h.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}h.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};d.extend(h,d.Base,{fetchData:function(d,i,c){var b=this,a,e=b.get("paramName"),h=b.get("parse"),j=b.get("cache"),p=b.get("allowEmpty");b.io&&(b.io.abort(),b.io=null);if(!d&&!0!==p)return i.call(c,[]);if(j&&(a=b.caches[d]))return i.call(c,a);a=b.get("xhrCfg");a.data=a.data||{};a.data[e]=
d;a.success=function(a){h&&(a=h(d,a));b.setInternal("data",a);j&&(b.caches[d]=a);i.call(c,a)};b.io=f(a)}});return h},{requires:["io"]});
KISSY.add("combobox/render",function(d,f,h){var l=d.all,i=f.Render.extend({createDom:function(){var c,b=this.get("input"),a=this.get("prefixCls"),e=this.get("el"),f=this.get("trigger");this.get("srcNode")||(e.append(d.substitute('<div class="{prefixCls}combobox-input-wrap"></div>',{prefixCls:a})),c=e.one("."+a+"combobox-input-wrap"),b=b||d.all(d.substitute('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="{prefixCls}combobox-input" />',{prefixCls:a})),
c.append(b),this.setInternal("input",b));f||this.setInternal("trigger",d.all(d.substitute('<div class="{prefixCls}combobox-trigger"><div class="{prefixCls}combobox-trigger-inner">&#x25BC;</div></div>',{prefixCls:a})));this.get("trigger").unselectable(h);this.setInternal("invalidEl",l("<div class='"+a+"combobox-invalid-el'><div class='"+a+"combobox-invalid-inner'></div></div>").insertBefore(b.parent(h,h),h));if(f=this.get("placeholder")){if(!(c=b.attr("id")))b.attr("id",c=d.guid("ks-combobox-input"));
this.setInternal("placeholderEl",l('<label for="'+c+'" class="'+a+'combobox-placeholder">'+f+"</label>").appendTo(e))}},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(c){this.get("input").attr("aria-expanded",c)},_onSetHasTrigger:function(c){var b=this.get("trigger");c?this.get("el").prepend(b):b.remove()},_onSetDisabled:function(c){i.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",c)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},
input:{},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{}},HTML_PARSER:{input:function(c){return c.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(c){return c.one("."+this.get("prefixCls")+"combobox-trigger")}}});return i},{requires:["component/base"]});
