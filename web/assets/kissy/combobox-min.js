/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: May 15 20:33
*/
KISSY.add("combobox/base",function(g,d,j,m,c,k){function b(e){var a=this,b;b=a.get("menu");e.target==b&&(e=b.get("el"),b=b.get("contentEl"),e.on("focusout",t,a),e.on("focusin",r,a),b.on("mouseover",l,a),b.on("mousedown",function(){a.setValueInternal(a.getValueInternal())}))}function a(e){e=e.target;e.isMenuItem&&(e=e.get("textContent"),this.setValueInternal(e),this._savedInputValue=e,this.set("collapsed",!0))}function l(){this.focus();r.call(this)}function h(e,a){var b=e.get("el"),l=e.get("prefixCls")+
"combobox-invalid",c=e.get("invalidEl");a?(b.addClass(l),c.attr("title",a),c.show()):(b.removeClass(l),c.hide())}function f(e,a){var b=e.get("menu");if(b&&!b.isController)if(a)b=e.createChild(b),e.setInternal("menu",b);else return null;return b}function i(){var e=f(this);e&&e.get("visible")&&this.alignInternal()}function t(){var e=this;e._focusoutDismissTimer=setTimeout(function(){e.set("collapsed",!0)},30)}function r(){var e;if(e=this._focusoutDismissTimer)clearTimeout(e),this._focusoutDismissTimer=
null}function o(){this.set("inputValue",this.get("input").val(),{data:{causeByTimer:1}})}function s(e){var a,b=[],l,c,h=f(this,1),e=this.normalizeData(e);h.removeChildren(!0);(c=h.get("highlightedItem"))&&c.set("highlighted",!1);if(e&&e.length){for(c=0;c<e.length;c++)a=e[c],b.push(h.addChild(a));e=this.getValueInternal();if(this.get("highlightMatchItem"))for(c=0;c<b.length;c++)if(b[c].get("textContent")==e){b[c].set("highlighted",!0);l=!0;break}if(!l&&this.get("autoHighlightFirst"))for(c=0;c<b.length;c++)if(!b[c].get("disabled")){b[c].set("highlighted",
!0);break}this.set("collapsed",!1);i.call(this)}else this.set("collapsed",!0)}var p,c=d.all,n=d.KeyCodes,q={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},u=c(g.Env.host);return p=j.Controller.extend({_savedInputValue:null,normalizeData:function(e){var a,b,c;if(e&&e.length){e=e.slice(0,this.get("maxItemCount"));a=this.get("format")?this.get("format").call(this,this.getValueInternal(),e):[];for(c=0;c<e.length;c++)b=e[c],a[c]=g.mix({content:b,textContent:b,value:b},a[c])}return a},bindUI:function(){this.get("input").on("valuechange",
o,this);this.on("click",a,this);u.on("resize",this.__repositionBuffer=g.buffer(i,50),this);this.on("afterRenderUI",b,this)},getValueInternal:function(){return this.get("input").val()},setValueInternal:function(e){this.set("inputValue",e)},_onSetInputValue:function(e,a){if(a.causeByTimer){var b;b=this.getValueInternal();b===k?this.set("collapsed",!0):(this._savedInputValue=b,this.sendRequest(b))}},alignInternal:function(){var e=this.get("menu"),a=e.get("align");delete a.node;a=g.clone(a);a.node=this.get("el");
g.mix(a,q,!1);e.set("align",a)},handleFocus:function(){var a;this.get("invalidEl")&&h(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlur:function(){var a=this,b=a.get("placeholderEl"),c=a.get("input");p.superclass.handleBlur.apply(a,arguments);t.call(a);a.get("invalidEl")&&a.validate(function(b,l){b?!a.get("focused")&&l==c.val()&&h(a,b):h(a,!1)});b&&!c.val()&&b.show()},handleMouseDown:function(a){var b,c;p.superclass.handleMouseDown.apply(this,arguments);b=a.target;c=this.get("trigger");
if(this.get("hasTrigger")&&(c[0]==b||c.contains(b)))this.get("input"),this.get("collapsed")?(this.focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyEventInternal:function(a){var b,c,l;c=f(this);this.get("input");b=this.get("updateInputOnDownUp");if(c&&c.get("visible")){l=c.handleKeydown(a);if(a.keyCode==n.ESC)return this.set("collapsed",!0),b&&this.setValueInternal(this._savedInputValue),!0;c=c.get("highlightedItem");b&&g.inArray(a.keyCode,[n.DOWN,n.UP])&&this.setValueInternal(c.get("textContent"));
return a.keyCode==n.TAB&&c&&(c.performActionInternal(),this.get("multiple"))?!0:l}if(a.keyCode==n.DOWN||a.keyCode==n.UP)if(a=this.getValueInternal(),a!==k)return this.sendRequest(a),!0;return k},validate:function(a){var b=this.get("validator"),c=this.getValueInternal();b?b(c,function(b){a(b,c)}):a(!1,c)},sendRequest:function(a){this.get("dataSource").fetchData(a,s,this)},_onSetCollapsed:function(a){if(a)(a=f(this))&&a.hide();else{var a=this.get("el"),b=f(this,1);r.call(this);b&&!b.get("visible")&&
(this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),this.get("input").attr("aria-owns",b.get("el").attr("id")))}},destructor:function(){var a=this.__repositionBuffer;a&&(u.detach("resize",a,this),a.stop())}},{ATTRS:{input:{view:1},inputValue:{value:"",sync:0,view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{},setter:function(a){a&&a.isController&&a.setInternal("parent",this)}},
defaultChildCfg:{value:{xclass:"popupmenu"}},collapsed:{view:1,sync:0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},xrender:{value:m}}},{xclass:"combobox",priority:10})},{requires:["node","component/base","./render","menu"]});KISSY.add("combobox/combobox-tpl",function(){return'<div id="ks-combobox-invalid-el{{id}}"      class="{{prefixCls}}combobox-invalid-el">     <div class="{{prefixCls}}combobox-invalid-inner"></div> </div>  {{#if hasTrigger}} <div id="ks-combobox-trigger{{id}}"      class="{{prefixCls}}combobox-trigger">     <div class="{{prefixCls}}combobox-trigger-inner">&#x25BC;</div> </div> {{/if}}  <div class="{{prefixCls}}combobox-input-wrap">      <input id="ks-combobox-input{{id}}"            aria-haspopup="true"            aria-autocomplete="list"            aria-haspopup="true"            role="autocomplete"            aria-expanded="false"      {{#if disabled}}     disabled     {{/if}}      autocomplete="off"     class="{{prefixCls}}combobox-input"      value="{{inputValue}}"     />       <label id="ks-combobox-placeholder{{id}}"            for="ks-combobox-input{{id}}"             style=\'display:{{#if inputValue}}none{{else}}block{{/if}};\'     class="{{prefixCls}}combobox-placeholder">     {{placeholder}}     </label> </div>'});
KISSY.add("combobox",function(g,d,j,m,c,k){d.LocalDataSource=c;d.RemoteDataSource=k;d.FilterSelect=m;d.MultiValueComboBox=j;return d},{requires:["combobox/base","combobox/multi-value-combobox","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/cursor",function(g,d){function j(b){var a=c,l;a||(a=d.create(m));"textarea"==""+b.type?d.css(a,"width",d.css(b,"width")):d.css(a,"width",9999);g.each(k,function(c){d.css(a,c,d.css(b,c))});c||(l=b.ownerDocument.body,l.insertBefore(a,l.firstChild));return c=a}var m="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",c,k="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(b){var b=d.get(b),a=b.ownerDocument,c,h,f=b.scrollTop,i=b.scrollLeft;if(a.selection)return a=a.selection.createRange(),{left:a.boundingLeft+i+d.scrollLeft(),top:a.boundingTop+f+a.boundingHeight+d.scrollTop()};c=d.offset(b);if("textarea"!=b.type)return c.top+=b.offsetHeight,c;h=j(b);a=b.selectionStart;h.innerHTML=g.escapeHTML(b.value.substring(0,a-1))+"<span>x</span>";d.offset(h,c);c=h.lastChild;b=d.offset(c);b.top+=d.height(c);0<a&&(b.left+=d.width(c));b.top-=f;b.left-=i;return b}},
{requires:["dom"]});KISSY.add("combobox/filter-select",function(g,d){var j=d.extend({validate:function(d){var c=this;j.superclass.validate.call(c,function(k,b){k?d(k,b):c.get("dataSource").fetchData(b,function(a){a:{if(a=c.normalizeData(a))for(var l=0;l<a.length;l++)if(a[l].textContent==b){a=a[l];break a}a=!1}d(a?"":c.get("invalidMessage"),b,a)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return j},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(g){function d(){d.superclass.constructor.apply(this,arguments)}d.ATTRS={data:{value:[]},parse:{value:function(d,m){var c=[],k=0;if(!d)return m;g.each(m,function(b){-1!=b.indexOf(d)&&c.push(b);k++});return c}}};g.extend(d,g.Base,{fetchData:function(d,m,c){var k=this.get("parse"),b=this.get("data"),b=k(d,b);m.call(c,b)}});return d},{requires:["component/base"]});
KISSY.add("combobox/multi-value-combobox",function(g,d,j){function m(a,b){return b&&-1!=a.indexOf(b)}function c(a){var c=a.get("input"),d=c.val(),f=[],i=[],g=a.get("literal"),j=a.get("separator"),a=a.get("separatorType"),o=!1,s=a!=k,c=c.prop("selectionStart"),p,n,q=-1;for(p=0;p<d.length;p++)(n=d.charAt(p),g&&n==g&&(o=!o),o)?i.push(n):(p==c&&(q=f.length),s&&b.test(n))?(i.length&&f.push(i.join("")),i=[],i.push(n)):m(j,n)?a==k?(i.push(n),i.length&&f.push(i.join("")),i=[]):(i.length&&f.push(i.join("")),
i=[],i.push(n)):i.push(n);i.length&&f.push(i.join(""));f.length||f.push("");-1==q&&(a==k&&m(j,n)&&f.push(""),q=f.length-1);return{tokens:f,cursorPosition:c,tokenIndex:q}}var k="suffix",b=/\s|\xa0/;return j.extend({getValueInternal:function(){this.get("input");var a=c(this),b=a.tokens,d=a.tokenIndex,a=this.get("separator"),f=this.get("separatorType"),b=b[d],d=b.length-1;if(f!=k)if(m(a,b.charAt(0)))b=b.slice(1);else return;else f==k&&m(a,b.charAt(d))&&(b=b.slice(0,d));return b},setValueInternal:function(a){var d=
this.get("input"),h=c(this),f=h.tokens,h=Math.max(0,h.tokenIndex),i=this.get("separator"),g=this.get("separatorType"),j=f[h+1]||"",o=f[h];if(g!=k){if(f[h]=o.charAt(0)+a,!j||!b.test(j.charAt(0)))f[h]+=" "}else f[h]=a,a=o.length-1,m(i,o.charAt(a))?f[h]+=o.charAt(a):1==i.length&&(f[h]+=i);a=f.slice(0,h+1).join("").length;d.val(f.join(""));d.prop("selectionStart",a);d.prop("selectionEnd",a)},alignInternal:function(){if(this.get("alignWithCursor")){var a=c(this),b=a.tokens,h=this.get("menu"),f=a.cursorPosition,
i=a.tokenIndex,a=this.get("input"),b=b.slice(0,i).join("").length;0<b&&++b;a.prop("selectionStart",b);a.prop("selectionEnd",b);b=d(a);a.prop("selectionStart",f);a.prop("selectionEnd",f);h.set("xy",[b.left,b.top])}else j.prototype.alignInternal.apply(this,arguments)}},{ATTRS:{separator:{value:",;"},separatorType:{value:k},literal:{value:'"'},alignWithCursor:{}}},{xclass:"multi-value-combobox",priority:20})},{requires:["./cursor","./base"]});
KISSY.add("combobox/RemoteDataSource",function(g,d){function j(){j.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}j.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};g.extend(j,g.Base,{fetchData:function(g,c,k){var b=this,a,j=b.get("paramName"),h=b.get("parse"),f=b.get("cache"),i=b.get("allowEmpty");b.io&&(b.io.abort(),b.io=null);if(!g&&!0!==i)return c.call(k,[]);if(f&&(a=b.caches[g]))return c.call(k,a);a=b.get("xhrCfg");a.data=a.data||{};a.data[j]=
g;a.success=function(a){h&&(a=h(g,a));b.setInternal("data",a);f&&(b.caches[g]=a);c.call(k,a)};b.io=d(a)}});return j},{requires:["io"]});
KISSY.add("combobox/render",function(g,d,j){var m=d.Render.extend({initializer:function(){var c=this.get("childrenElSelectors");g.mix(c,{input:"#ks-combobox-input{id}",trigger:"#ks-combobox-trigger{id}",invalidEl:"#ks-combobox-invalid-el{id}",placeholderEl:"#ks-combobox-placeholder{id}"})},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(c){this.get("input").attr("aria-expanded",!c)},_onSetInputValue:function(c,d){d.causeByTimer||this.get("input").val(c)},_onSetDisabled:function(c){m.superclass._onSetDisabled.apply(this,
arguments);this.get("input").attr("disabled",c)}},{ATTRS:{collapsed:{value:!0,sync:0},hasTrigger:{value:!0,sync:0},inputValue:{sync:0},input:{},disabled:{sync:0},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{},contentTpl:{value:j}},HTML_PARSER:{input:function(c){return c.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(c){return c.one("."+this.get("prefixCls")+"combobox-trigger")},invalidEl:function(c){return c.one("."+this.get("prefixCls")+"combobox-invalid-el")},placeholderEl:function(c){return c.one("."+
this.get("prefixCls")+"combobox-placeholder")}}});return m},{requires:["component/base","./combobox-tpl"]});
