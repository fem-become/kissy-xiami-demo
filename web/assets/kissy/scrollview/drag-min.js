/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: May 21 22:52
*/
KISSY.add("scrollview/drag",function(s,C,D,t){function v(b,c,a){var c=c.timeStamp,g=b.get("scroll"+s.ucfirst(a));b._startScroll[a]=g;b._swipe[a].startTime=c;b._swipe[a].scroll=g}function w(b,c,a,g){if(!x(b,a)){var d="left"==a?"pageX":"pageY",h=b._lastPageXY,j,f=b._startScroll[a]-(c[d]-g[a]),g=c.timeStamp,i=b.minScroll,e=b.maxScroll,k=b._lastDirection,m=b._swipe,l;h[d]&&(j=c[d]==h[d],l=0<c[d]-h[d]);f<i[a]?(f=i[a]-f,f*=y,f=i[a]-f):f>e[a]&&(f-=e[a],f*=y,f=e[a]+f);i=g-m[a].startTime;if(!j&&void 0!==k[a]&&
k[a]!==l||i>E)m[a].startTime=g,m[a].scroll=f;b.set("left"==a?"scrollLeft":"scrollTop",f);k[a]=l;h[d]=c[d]}}function x(b,c){return!b._allowScroll[c]&&b.get("left"==c?"lockX":"lockY")?1:0}function z(b,c,a,g){if(x(b,a))g();else{var d="left"==a,h="scroll"+(d?"Left":"Top"),j=b.get("contentEl"),f=b.get(h),i={},e=b.minScroll,k=b.maxScroll,m=c.timeStamp,c=b._swipe,l;f<e[a]?l=e[a]:f>k[a]&&(l=k[a]);void 0!==l?(a=[void 0,void 0,{duration:b.get("bounceDuration"),easing:b.get("bounceEasing"),queue:!1,complete:g}],
a[d?0:1]=l,b.scrollTo.apply(b,a)):b._pagesXY?g():(d=m-c[a].startTime,l=f-c[a].scroll,0==d||0==l?g():(d=Math.min(Math.max(l/d,-A),A),i[a]={fx:{frame:F(b,d,f,h,k[a],e[a])}},j.animate(i,{duration:9999,queue:!1,complete:g})))}}function F(b,c,a,g,d,h){var j=c*n,f=1,i=0;return function(e){var c=s.now();if(f){var e=c-e.startTime,m=Math.exp(e*G),e=parseInt(a+j*(1-m)/-B);e>h&&e<d?(this.lastValue===e&&(this.finished=1),this.lastValue=e,b.set(g,e)):(f=0,j*=m,a=e<=h?h:d,i=c)}else e=c-i,c=e/n,c*=Math.exp(-H*c),
e=parseInt(j*c),0===e&&(this.finished=1),b.set(g,a+e)}}var y=0.5,E=300,A=6,n=20,B=Math.log(0.95),G=B/n,H=0.3;return C.extend({bindUI:function(){var b=this.get("contentEl");(this.dd=new D.Draggable({node:b,groups:!1,halt:!0})).on("dragstart",this._onDragStart,this).on("drag",this._onDrag,this).on("dragend",this._onDragEnd,this);this.get("el").on(t.Gesture.start,this._onGestureStart,this);b.on(t.Gesture.start,this._onGestureStart,this)},syncUI:function(){this._initStates()},destructor:function(){this.dd.destroy();
this.stopAnimation()},_onGestureStart:function(b){this.stopAnimation();if(this.__scrolling){var c=b.pageX,a=this.get("pageIndex"),g=b.pageY;-1!=b.type.indexOf("touch")&&(c=b.touches[0].pageX,g=b.touches[0].pageY);this.__scrolling=0;this.fire("scrollEnd",{pageX:c,pageY:g,fromPageIndex:a,pageIndex:a})}},_onDragStart:function(b){this._initStates();this._dragStartMousePos={left:b.pageX,top:b.pageY};v(this,b,"left");v(this,b,"top");this.fire("scrollStart",{pageX:b.pageX,pageY:b.pageY});this.__scrolling=
1},_onDrag:function(b){var c=this._dragStartMousePos;w(this,b,"left",c);w(this,b,"top",c)},_onDragEnd:function(b){function c(){g++;if(2==g){var c=function(){a.fire("scrollEnd",{pageX:b.pageX,pageY:b.pageY,fromPageIndex:t,pageIndex:a.get("pageIndex")})};if(a._pagesXY){a.get("snapThreshold");var d=a.get("snapDuration"),n=a.get("snapEasing"),t=a.get("pageIndex"),u=a.get("scrollLeft"),o=a.get("scrollTop"),d={duration:d,easing:n,complete:c},n=a._pagesXY.concat([]);a.__scrolling=0;if(e||k)if(e&&k&&f&&i){var p=
[],q=void 0;s.each(n,function(a){a&&(0<h&&a.x>u?p.push(a):0>h&&a.x<u&&p.push(a))});var r;0<j?(r=Number.MAX_VALUE,s.each(p,function(a){a.y>o&&r<a.y-o&&(r=a.y-o,q=p.index)})):(r=Number.MAX_VALUE,s.each(p,function(a){a.y<o&&r<o-a.y&&(r=o-a.y,q=p.index)}));void 0!=q?q!=t?a.scrollToPage(q,d):(a.scrollToPage(q),c()):c()}else e&&f||k&&i?(c=a._getPageIndexFromXY(e?u:o,e,e?h:j),a.scrollToPage(c,d)):(a.scrollToPage(a.get("pageIndex")),c())}else c()}}var a=this,g=0,d=a._dragStartMousePos,h=d.left-b.pageX,j=
d.top-b.pageY,d=a.get("snapThreshold"),f=Math.abs(h)>d,i=Math.abs(j)>d,e=a._allowScroll.left,k=a._allowScroll.top;z(a,b,"left",c);z(a,b,"top",c)},_initStates:function(){this._lastPageXY={};this._lastDirection={};this._swipe={left:{},top:{}};this._startScroll={}},_onSetDisabled:function(b){this.dd.set("disabled",b)}},{ATTRS:{lockX:{value:!0},lockY:{value:!1},snapThreshold:{value:5},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}}})},{requires:["./base","dd/base","event"]});
