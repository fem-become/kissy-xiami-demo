/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Mar 25 15:07
*/
KISSY.add("scrollview/drag",function(p,y,z,q){function r(a,c,b){var c=c.timeStamp,g=a.get("scroll"+p.ucfirst(b));a._startScroll[b]=g;a._swipe[b].startTime=c;a._swipe[b].scroll=g}function s(a,c,b,g){if(!t(a,b)){var h="left"==b?"pageX":"pageY",f=a._lastPageXY,j,d=a._startScroll[b]-(c[h]-g[b]),g=c.timeStamp,k=a.minScroll,m=a.maxScroll,e=a._lastDirection,i=a._swipe,l;f[h]&&(j=c[h]==f[h],l=0<c[h]-f[h]);d<k[b]?(d=k[b]-d,d*=u,d=k[b]-d):d>m[b]&&(d-=m[b],d*=u,d=m[b]+d);k=g-i[b].startTime;if(!j&&void 0!==e[b]&&
e[b]!==l||k>A)i[b].startTime=g,i[b].scroll=d;a.set("left"==b?"scrollLeft":"scrollTop",d);e[b]=l;f[h]=c[h]}}function n(a,c,b){a.fire("scrollEnd",{axis:c,pageX:b.pageX,pageY:b.pageY})}function t(a,c){return!a._allowScroll[c]&&a.get("left"==c?"lockX":"lockY")?1:0}function v(a,c,b){if(!t(a,b)){var g="scroll"+("left"==b?"Left":"Top"),h=a.get("contentEl"),f=a.get(g),j="left"==b?"x":"y",d={},k=a.minScroll,m=a.maxScroll,e=c.timeStamp,i=a._swipe,l;f<k[b]?l=k[b]:f>m[b]&&(l=m[b]);void 0!==l?(d[b]={fx:{frame:function(b,
c){a.set(g,f+c.pos*(l-f))}}},h.animate(d,{duration:a.get("bounceDuration"),easing:a.get("bounceEasing"),queue:!1,complete:function(){n(a,j,c)}})):(e-=i[b].startTime,0==e?n(a,j,c):(i=f-i[b].scroll,0==i?n(a,j,c):(i=Math.min(Math.max(i/e,-w),w),d[b]={fx:{frame:B(a,i,f,g,m[b],k[b])}},h.animate(d,{duration:9999,queue:!1,complete:function(){n(a,j,c)}}))))}}function B(a,c,b,g,h,f){var j=c*o,d=1,k=0;return function(c){var e=p.now();if(d){var c=e-c.startTime,i=Math.exp(c*C),c=parseInt(b+j*(1-i)/-x);c>f&&c<
h?(this.lastValue===c&&(this.finished=1),this.lastValue=c,a.set(g,c)):(d=0,j*=i,b=c<=f?f:h,k=e)}else c=e-k,e=c/o,e*=Math.exp(-D*e),c=parseInt(j*e),0===c&&(this.finished=1),a.set(g,b+c)}}var u=0.5,A=300,w=6,o=20,x=Math.log(0.95),C=x/o,D=0.3;return y.extend({bindUI:function(){var a=this.get("contentEl");(this.dd=new z.Draggable({node:a,groups:!1,halt:!0})).on("dragstart",this._onDragStart,this).on("drag",this._onDrag,this).on("dragend",this._onDragEnd,this);this.get("el").on(q.Gesture.start,this._onGestureStart,
this);a.on(q.Gesture.start,this._onGestureStart,this)},syncUI:function(){this._initStates()},destructor:function(){this.dd.destroy();this.stopAnimation()},_onGestureStart:function(){this.stopAnimation()},_onDragStart:function(a){this._initStates();this._dragStartMousePos={left:a.pageX,top:a.pageY};r(this,a,"left");r(this,a,"top");this.fire("scrollStart",{pageX:a.pageX,pageY:a.pageY})},_onDrag:function(a){var c=this._dragStartMousePos;s(this,a,"left",c);s(this,a,"top",c)},_onDragEnd:function(a){v(this,
a,"left");v(this,a,"top")},_initStates:function(){this._lastPageXY={};this._lastDirection={};this._swipe={left:{},top:{}};this._startScroll={}},_onSetDisabled:function(a){this.dd.set("disabled",a)}},{ATTRS:{lockX:{value:!0},lockY:{value:!1},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}}})},{requires:["./base","dd/base","event"]});
